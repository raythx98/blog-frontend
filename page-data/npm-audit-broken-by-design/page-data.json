{"componentChunkName":"component---src-templates-blog-post-js","path":"/npm-audit-broken-by-design/","result":{"data":{"site":{"siteMetadata":{"title":"Overreacted","author":"Dan Abramov"}},"markdownRemark":{"id":"d9242b7c-1591-5001-875b-0306ddca76b5","html":"<p>Security is important. Nobody wants to be the person advocating for less security. So nobody wants to say it. But somebody has to say it.</p>\n<p>So I guess I’ll say it.</p>\n<p><strong>The way <code class=\"language-text\">npm audit</code> works is broken. Its rollout as a default after every <code class=\"language-text\">npm install</code> was rushed, inconsiderate, and inadequate for the front-end tooling.</strong></p>\n<p>Have you heard the story about <a href=\"https://en.wikipedia.org/wiki/The_Boy_Who_Cried_Wolf\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">the boy who cried wolf?</a> Spoiler alert: the wolf eats the sheep. If we don’t want our sheep to be eaten, we need better tools.</p>\n<p>As of today, <code class=\"language-text\">npm audit</code> is a stain on the entire npm ecosystem. The best time to fix it was before rolling it out as a default. The next best time to fix it is now.</p>\n<p>In this post, I will briefly outline how it works, why it’s broken, and what changes I’m hoping to see.</p>\n<hr>\n<p><em>Note: this article is written with a critical and somewhat snarky tone. I understand it’s super hard to maintain massive projects like Node.js/npm, and that mistakes may take a while to become become apparent. I am frustrated only at the situation, not at the people involved. I kept the snarky tone because the level of my frustration has increased over the years, and I don’t want to pretend that the situation isn’t as dire as it really is. Most of all I am frustrated to see all the people for whom this is the first programming experience, as well as all the people who are blocked from deploying their changes due to irrelevant warnings. I am excited that <a href=\"https://twitter.com/bitandbang/status/1412803378279759872\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">this issue is being considered</a> and I will do my best to provide input on the proposed solutions! 💜</em></p>\n<hr>\n<h2 id=\"how-does-npm-audit-work\"><a href=\"#how-does-npm-audit-work\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How does npm audit work?</h2>\n<p><em><a href=\"#why-is-npm-audit-broken\">Skip ahead</a> if you already know how it works.</em></p>\n<p>Your Node.js application has a dependency tree. It might look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">your-app\n  - view-library@1.0.0\n  - design-system@1.0.0\n  - model-layer@1.0.0\n    - database-layer@1.0.0\n      - network-utility@1.0.0</code></pre></div>\n<p>Most likely, it’s a lot deeper.</p>\n<p>Now say there’s a vulnerability discovered in <code class=\"language-text\">network-utility@1.0.0</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">your-app\n  - view-library@1.0.0\n  - design-system@1.0.0\n  - model-layer@1.0.0\n    - database-layer@1.0.0\n      - network-utility@1.0.0 (Vulnerable!)</code></pre></div>\n<p>This gets published in a special registry that <code class=\"language-text\">npm</code> will access next time you run <code class=\"language-text\">npm audit</code>. Since npm v6+, you’ll learn about this after every <code class=\"language-text\">npm install</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">1 vulnerabilities (0 moderate, 1 high)\n\nTo address issues that do not require attention, run:\n  npm audit fix\n\nTo address all issues (including breaking changes), run:\n  npm audit fix --force</code></pre></div>\n<p>You run <code class=\"language-text\">npm audit fix</code>, and npm tries to install the latest <code class=\"language-text\">network-utility@1.0.1</code> with the fix in it. As long as <code class=\"language-text\">database-layer</code> specifies that it depends not on <em>exactly</em> on <code class=\"language-text\">network-utility@1.0.0</code> but some permissible range that includes <code class=\"language-text\">1.0.1</code>, the fix “just works” and you get a working application:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">your-app\n  - view-library@1.0.0\n  - design-system@1.0.0\n  - model-layer@1.0.0\n    - database-layer@1.0.0\n      - network-utility@1.0.1 (Fixed!)</code></pre></div>\n<p>Alternatively, maybe <code class=\"language-text\">database-layer@1.0.0</code> depends strictly on <code class=\"language-text\">network-utility@1.0.0</code>. In that case, the maintainer of <code class=\"language-text\">database-layer</code> needs to release a new version too, which would allow <code class=\"language-text\">network-utility@1.0.1</code> instead:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">your-app\n  - view-library@1.0.0\n  - design-system@1.0.0\n  - model-layer@1.0.0\n    - database-layer@1.0.1 (Updated to allow the fix.)\n      - network-utility@1.0.1 (Fixed!)</code></pre></div>\n<p>Finally, if there is no way to gracefully upgrade the tree, you could try <code class=\"language-text\">npm audit fix --force</code>. This is supposed to be used if <code class=\"language-text\">database-layer</code> doesn’t accept the new version of <code class=\"language-text\">network-utility</code> and <em>also</em> doesn’t release an update to accept it. So you’re kind of taking matters in your own hands, potentially risking breaking changes. Seems like a reasonable option to have.</p>\n<p><strong>This is how <code class=\"language-text\">npm audit</code> is supposed to work in theory.</strong></p>\n<p>As someone wise said, in theory there is no difference between theory and practice. But in practice there is. And that’s where all the fun starts.</p>\n<h2 id=\"why-is-npm-audit-broken\"><a href=\"#why-is-npm-audit-broken\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Why is npm audit broken?</h2>\n<p>Let’s see how this works in practice. I’ll use Create React App for my testing.</p>\n<p>If you’re not familiar with it, it’s an integration facade that combines multiple other tools, including Babel, webpack, TypeScript, ESLint, PostCSS, Terser, and others. Create React App takes your JavaScript source code and converts it into a static HTML+JS+CSS folder. <strong>Notably, it does <em>not</em> produce a Node.js app.</strong></p>\n<p>Let’s create a new project!</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npx create-react-app myapp</code></pre></div>\n<p>Immediately upon creating a project, I see this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">found 5 vulnerabilities (3 moderate, 2 high)\n  run `npm audit fix` to fix them, or `npm audit` for details</code></pre></div>\n<p>Oh no, that seems bad! My just-created app is already vulnerable!</p>\n<p>Or so npm tells me.</p>\n<p>Let’s run <code class=\"language-text\">npm audit</code> to see what’s up.</p>\n<h3 id=\"first-vulnerability\"><a href=\"#first-vulnerability\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a> First “vulnerability”</h3>\n<p>Here is the first problem reported by <code class=\"language-text\">npm audit</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">┌───────────────┬──────────────────────────────────────────────────────────────┐\n│ Moderate      │ Regular Expression Denial of Service                         │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ Package       │ browserslist                                                 │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ Patched in    │ &gt;=4.16.5                                                     │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ Dependency of │ react-scripts                                                │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ Path          │ react-scripts &gt; react-dev-utils &gt; browserslist               │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ More info     │ https://npmjs.com/advisories/1747                            │\n└───────────────┴──────────────────────────────────────────────────────────────┘</code></pre></div>\n<p>Apparently, <code class=\"language-text\">browserslist</code> is vulnerable. What’s that and how is it used? Create React App generates CSS files optimized for the browsers you target. For example, you can say you only target modern browsers in your <code class=\"language-text\">package.json</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">  <span class=\"token string\">\"browserslist\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"production\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\">0.2%\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"not dead\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"not op_mini all\"</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"development\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"last 1 chrome version\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"last 1 firefox version\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">\"last 1 safari version\"</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Then it won’t include outdated flexbox hacks in the output. Since multiple tools rely on the same configuration format for the browsers you target, Create React App uses the shared <code class=\"language-text\">browserslist</code> package to parse the configuration file.</p>\n<p>So what’s the vulnerability here? <a href=\"https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">“Regular Expression Denial of Service”</a> means that there is a regex in <code class=\"language-text\">browserslist</code> that, with malicious input, could become very slow. So an attacker can craft a special configuration string that, when passed to <code class=\"language-text\">browserslist</code>, could slow it down exponentially. This sounds bad…</p>\n<p>Wait, what?! Let’s remember how your app works. You have a configuration file <em>on your machine</em>. You <em>build</em> your project. You get static HTML+CSS+JS in a folder. You put it on static hosting. There is simply <strong>no way</strong> for your application user to affect your <code class=\"language-text\">package.json</code> configuration. <strong>This doesn’t make any sense.</strong> If the attacker already has access to your machine and can change your configuration files, you have a much bigger problem than slow regular expressions!</p>\n<p>Okay, so I guess this “Moderate” “vulnerability” was neither moderate nor a vulnerability in the context of a project. Let’s keep going.</p>\n<p><strong>Verdict: this “vulnerability” is absurd in this context.</strong></p>\n<h3 id=\"second-vulnerability\"><a href=\"#second-vulnerability\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Second “vulnerability”</h3>\n<p>Here is the next issue <code class=\"language-text\">npm audit</code> has helpfully reported:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">┌───────────────┬──────────────────────────────────────────────────────────────┐\n│ Moderate      │ Regular expression denial of service                         │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ Package       │ glob-parent                                                  │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ Patched in    │ &gt;=5.1.2                                                      │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ Dependency of │ react-scripts                                                │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ Path          │ react-scripts &gt; webpack-dev-server &gt; chokidar &gt; glob-parent  │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ More info     │ https://npmjs.com/advisories/1751                            │\n└───────────────┴──────────────────────────────────────────────────────────────┘</code></pre></div>\n<p>Let’s look at the <code class=\"language-text\">webpack-dev-server &gt; chokidar &gt; glob-parent</code> dependency chain. Here, <code class=\"language-text\">webpack-dev-server</code> is a <strong>development-only</strong> server that’s used to quickly serve your app <strong>locally</strong>. It uses <code class=\"language-text\">chokidar</code> to watch your filesystem for changes (such as when you save a file in your editor). And it uses <a href=\"https://www.npmjs.com/package/glob-parent\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">glob-parent</code></a> in order to extract a part of the filesystem path from a filesystem watch pattern.</p>\n<p>Unfortunately, <code class=\"language-text\">glob-parent</code> is vulnerable! If an attacker supplies a specially crafted filepath, it could make this function exponentially slow, which would…</p>\n<p>Wait, what?! The development server is on your computer. The files are on your computer. The file watcher is using the configuration that <em>you</em> have specified. None of this logic leaves your computer. If your attacker is sophisticated enough to log into <em>your machine</em> during local development, the last thing they’ll want to do is to craft special long filepaths to slow down your development. They’ll want to steal your secrets instead. <strong>So this whole threat is absurd.</strong></p>\n<p>Looks like this “Moderate” “vulnerability” was neither moderate nor a vulnerability in the context of a project.</p>\n<p><strong>Verdict: this “vulnerability” is absurd in this context.</strong></p>\n<h3 id=\"third-vulnerability\"><a href=\"#third-vulnerability\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a> Third “vulnerability”</h3>\n<p>Let’s have a look at this one:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">┌───────────────┬──────────────────────────────────────────────────────────────┐\n│ Moderate      │ Regular expression denial of service                         │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ Package       │ glob-parent                                                  │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ Patched in    │ &gt;=5.1.2                                                      │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ Dependency of │ react-scripts                                                │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ Path          │ react-scripts &gt; webpack &gt; watchpack &gt; watchpack-chokidar2 &gt;  │\n│               │ chokidar &gt; glob-parent                                       │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ More info     │ https://npmjs.com/advisories/1751                            │\n└───────────────┴──────────────────────────────────────────────────────────────┘</code></pre></div>\n<p>Wait, it’s the same thing as above, but through a different dependency path.</p>\n<p><strong>Verdict: this “vulnerability” is absurd in this context.</strong></p>\n<h3 id=\"fourth-vulnerability\"><a href=\"#fourth-vulnerability\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fourth “vulnerability”</h3>\n<p>Oof, this one looks really bad! <strong><code class=\"language-text\">npm audit</code> has the nerve to show it in red color:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">┌───────────────┬──────────────────────────────────────────────────────────────┐\n│ High          │ Denial of Service                                            │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ Package       │ css-what                                                     │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ Patched in    │ &gt;=5.0.1                                                      │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ Dependency of │ react-scripts                                                │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ Path          │ react-scripts &gt; @svgr/webpack &gt; @svgr/plugin-svgo &gt; svgo &gt;   │\n│               │ css-select &gt; css-what                                        │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ More info     │ https://npmjs.com/advisories/1754                            │\n└───────────────┴──────────────────────────────────────────────────────────────┘</code></pre></div>\n<p>What is this “high” severity issue? “Denial of service.” I don’t want service to be denied! That would be really bad… Unless…</p>\n<p>Let’s look at the <a href=\"https://www.npmjs.com/advisories/1754\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">issue</a>. Apparently <a href=\"https://www.npmjs.com/package/css-what\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">css-what</code></a>, which is a parser for CSS selectors, can be slow with specially crafted input. This parser is used by a plugin that generates React components from SVG files.</p>\n<p>So what this means is that if the attacker takes control of my development machine or my source code, they put a special SVG file that will have a specially crafted CSS selector in it, which will make my build slow. That checks out…</p>\n<p>Wait, what?! If the attacker can modify my app’s source code, they’ll probably just put a bitcoin miner in it. Why would they add SVG files into my app, unless you can mine bitcoins with SVG? Again, this doesn’t make <em>any</em> sense.</p>\n<p><strong>Verdict: this “vulnerability” is absurd in this context.</strong></p>\n<p>So much for the “high” severity.</p>\n<h3 id=\"fifth-vulnerability\"><a href=\"#fifth-vulnerability\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fifth “vulnerability”</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">┌───────────────┬──────────────────────────────────────────────────────────────┐\n│ High          │ Denial of Service                                            │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ Package       │ css-what                                                     │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ Patched in    │ &gt;=5.0.1                                                      │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ Dependency of │ react-scripts                                                │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ Path          │ react-scripts &gt; optimize-css-assets-webpack-plugin &gt; cssnano │\n│               │ &gt; cssnano-preset-default &gt; postcss-svgo &gt; svgo &gt; css-select  │\n│               │ &gt; css-what                                                   │\n├───────────────┼──────────────────────────────────────────────────────────────┤\n│ More info     │ https://npmjs.com/advisories/1754                            │\n\n└───────────────┴──────────────────────────────────────────────────────────────┘</code></pre></div>\n<p>This is just the same exact thing as above.</p>\n<p><strong>Verdict: this “vulnerability” is absurd in this context.</strong></p>\n<h3 id=\"shall-we-keep-going\"><a href=\"#shall-we-keep-going\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Shall we keep going?</h3>\n<p>So far the boy has cried wolf five times. Two of them are duplicates. The rest are absurd non-issues in the context of how these dependencies are used.</p>\n<p>Five false alarms wouldn’t be too bad.</p>\n<p><strong>Unfortunately, there are hundreds.</strong></p>\n<p>Here are a <a href=\"https://github.com/facebook/create-react-app/issues/11053\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">few</a> <a href=\"https://github.com/facebook/create-react-app/issues/11092\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">typical</a> threads, but there are many more <a href=\"https://github.com/facebook/create-react-app/issues/11174\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">linked from here</a>:</p>\n<img src=\"https://imgur.com/ABDK4Ky.png\" alt=\"Screenshot of many GH threads\">\n<p><strong>I’ve spent several hours looking through every <code class=\"language-text\">npm audit</code> issue reported to us over the last several months, and they all appear to be false positives in the context of a build tool dependency like Create React App.</strong></p>\n<p>Of course, they are possible to fix. We could relax some of the top-level dependencies to not be exact (leading to bugs in patches slipping in more often). We could make more releases just to stay ahead of this security theater.</p>\n<p>But this is inadequate. Imagine if your tests failed 99% of the times for bogus reasons! This wastes person-decades of effort and makes everyone miserable:</p>\n<ul>\n<li><strong>It makes beginners miserable</strong> because they run into this as their first programming experience in the Node.js ecosystem. As if installing Node.js/npm was not confusing enough (good luck if you added <code class=\"language-text\">sudo</code> somewhere because a tutorial told you), this is what they’re greeted with when they try examples online or even when they create a project. A beginner doesn’t know what a RegExp <em>is</em>. Of course they don’t have the know-how to be able to tell whether a RegExp DDoS or prototype pollution is something to worry about when they’re using a build tool to produce a static HTML+CSS+JS site.</li>\n<li><strong>It makes experienced app developers miserable</strong> because they have to either waste time doing obviously unnecessary work, or fight with their security departments trying to explain how <code class=\"language-text\">npm audit</code> is a broken tool unsuitable for real security audits <em>by design</em>. Yeah, somehow it was made a default in this state.</li>\n<li><strong>It makes maintainers miserable</strong> because instead of working on bugfixes and improvements, they have to pull in bogus vulnerability fixes that can’t possibly affect their project because otherwise their users are frustrated, scared, or both.</li>\n<li><strong>Someday, it will make our users miserable</strong> because we have trained an entire generation of developers to either not understand the warnings due to being overwhelmed, or to simply <em>ignore</em> them because they always show up but the experienced developers (correctly) tell them there is no real issue in each case.</li>\n</ul>\n<p>It doesn’t help that <code class=\"language-text\">npm audit fix</code> (which the tool suggests using) is buggy. I ran <code class=\"language-text\">npm audit fix --force</code> today and it <strong>downgraded</strong> the main dependency to a three-year-old version with actual <em>real</em> vulnerabilities. Thanks, npm, great job.</p>\n<h2 id=\"what-next\"><a href=\"#what-next\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What next?</h2>\n<p>I don’t know how to solve this. But I didn’t add this system in the first place, so I’m probably not the best person to solve it. All I know is it’s horribly broken.</p>\n<p>There are a few possible solutions that I have seen.</p>\n<ul>\n<li>\n<p><strong>Move dependency to <code class=\"language-text\">devDependencies</code> if it doesn’t run in production.</strong> This offers a way to specify that some dependency isn’t used in production code paths, so there is no risk associated with it. However, this solution is flawed:</p>\n<ul>\n<li><code class=\"language-text\">npm audit</code> still warns for development dependencies by default. You have to <em>know</em> to run <code class=\"language-text\">npm audit --production</code> to not see the warnings from development dependencies. People who know to do that probably already don’t trust it anyway. This also doesn’t help beginners or people working at companies whose security departments want to audit everything.</li>\n<li><code class=\"language-text\">npm install</code> still uses information from plain <code class=\"language-text\">npm audit</code>, so you will effectively still see all the false positives every time you install something.</li>\n<li>As any security professional will tell you, development dependencies actually <em>are</em> an attack vector, and perhaps one of the most dangerous ones because it’s so hard to detect and the code runs with high trust assumptions. <strong>This is why the situation is so bad in particular: any real issue gets buried below dozens of non-issues that <code class=\"language-text\">npm audit</code> is training people and maintainers to ignore.</strong> It’s only a matter of time until this happens.</li>\n</ul>\n</li>\n<li><strong>Inline all dependencies during publish.</strong> This is what I’m increasingly seeing packages similar to Create React App do. For example, both <a href=\"https://unpkg.com/browse/vite@2.4.1/dist/node/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Vite</a> and <a href=\"https://unpkg.com/browse/next@11.0.1/dist/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Next.js</a> simply bundle their dependencies directly in the package instead of relying on the npm <code class=\"language-text\">node_modules</code> mechanism. From a maintainer’s point of view, <a href=\"https://github.com/vitejs/vite/blob/main/.github/contributing.md#notes-on-dependencies\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">the upsides are clear</a>: you get faster boot time, smaller downloads, and — as a nice bonus — no bogus vulnerability reports from your users. It’s a neat way to game the system but I’m worried about the incentives npm is creating for the ecosystem. Inlining dependencies kind of goes against the whole point of npm.</li>\n<li><strong>Offer some way to counter-claim vulnerability reports.</strong> The problem is not entirely unknown to Node.js and npm, of course. Different people have worked on different suggestions to fix it. For example, there is a <a href=\"https://github.com/npm/rfcs/pull/18\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">proposal</a> for a way to manually resolve audit warnings so that they don’t display again. However, this still places the burden on app users, which don’t necessarily have context on what vulnerabilities deeper in the tree are real or bogus. I also have a <a href=\"https://twitter.com/dan_abramov/status/1412380714012594178\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">proposal</a>: I need a way to mark for my users that a certain vulnerability can’t possibly affect them. If you don’t trust my judgement, why are you running my code on your computer? I’d be happy to discuss other options too.</li>\n</ul>\n<p>The root of the issue is that npm added a default behavior that, in many situations, leads to a 99%+ false positive rate, creates an incredibly confusing first programming experience, makes people fight with security departments, makes maintainers never want to deal with Node.js ecosystem ever again, and at some point will lead to actually bad vulnerabilities slipping in unnnoticed.</p>\n<p>Something has to be done.</p>\n<p>In the meantime, I am planning to close all GitHub issues from <code class=\"language-text\">npm audit</code> that I see going forward that don’t correspond to a <em>real</em> vulnerability that can affect the project. I invite other maintainers to adopt the same policy. This will create frustration for our users, but the core of the issue is with npm. I am done with this security theater. Node.js/npm have all the power to fix the problem. I am in contact with them, and I hope to see this problem prioritized.</p>\n<p>Today, <code class=\"language-text\">npm audit</code> is broken by design.</p>\n<p>Beginners, experienced developers, maintainers, security departments, and, most importantly — our users — deserve better.</p>","timeToRead":14,"frontmatter":{"title":"npm audit: Broken by Design","date":"July 07, 2021","spoiler":"Found 99 vulnerabilities (84 moderately irrelevant, 15 highly irrelevant)","cta":null},"fields":{"slug":"/npm-audit-broken-by-design/","langKey":"en"}}},"pageContext":{"slug":"/npm-audit-broken-by-design/","previous":{"fields":{"slug":"/before-you-memo/","langKey":"en","directoryName":"before-you-memo","maybeAbsoluteLinks":[]},"frontmatter":{"title":"Before You memo()"}},"next":null,"translations":[],"translatedLinks":[]}},"staticQueryHashes":["336482444"]}